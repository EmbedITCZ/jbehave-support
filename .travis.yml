language: java
jdk:
- oraclejdk8

install: true
dist: trusty
sudo: required

cache:
  directories:
  - '$HOME/.m2/repository'

stages:
- build
- test
- system-test

env:
  secure: "hI4klrgHh1K5TKFZ8gGlEhNL076svtGuMt9zgHjIiVCrYwlcNHIBwSfAlg5sBmAeoYFldFbhTOt9YwInimb/hdfjqVcsL2oq8BVMa7WKtIGlZI80qdjcNG6ire5VfF5gJL95fGP+lx/HkYkQFla20z1VwPDzDrXkfMeT7WjUZeO6zUhsd/sOWLwRknVQC+RHu5X36yfsDeJdOSLFcMLL09Rutf+kPIg3wWVPxbkfLgT/uPDCsRxWD7NFTMBG5ewRLHOBPS00WN9J8ZNWVUsi+A6XcxpvG3Jbl35YL1KyUNK8J9eBkUJmydk3iaN4cRgWGX1zE2DhuiBXW17owY3u1qySo5sOTMguCHjuhPiy/N/lM2P/eEQ6Npl3gi7IltDV8bdrBZ/Zo8ttAkqvTXA8v+Fm1pbDh7V+xM9ldZRKatVqfjYo0DRODulLsnu9Hd1OqDhq24SruaXtd53pqH6EQDB2E6yhQqvCRvyruMCF/HOIycMxejfAuuU7bhOGraxuRuWM3l69tiMaL3R1/e3O4v42qxdSeOXk8Zi5iU6hT6ooI8LJ6tqR/Twa1sy0k/n9wuF0hLoqj66/wC+Y8vcIi+6mRO0viLwLmjzOW+icJi+FfZwJJg/OQ/aFHz8enVkFGFjuwcMIabfHkgB8mWUrZSW3KUQpMhCqse4eE18NCBI="

jobs:
  include:
  - stage: build
    script: mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
  - stage: test
    script:
    - mvn org.jacoco:jacoco-maven-plugin:prepare-agent test org.jacoco:jacoco-maven-plugin:report -B -V
    - curl --silent -o jbehave-support-core/target/codacy-reporter-latest.jar -L https://github.com/codacy/codacy-coverage-reporter/releases/download/4.0.3/codacy-coverage-reporter-4.0.3-assembly.jar
    - java -jar jbehave-support-core/target/codacy-reporter-latest.jar report -l Java -r jbehave-support-core/target/site/jacoco/jacoco.xml --partial
  - stage: system-test
    addons:
      chrome: stable
    before_script:
    - "chmod +x report_upload.sh"
    - "export DISPLAY=:99.0"
    - "sh -e /etc/init.d/xvfb start"
    - sleep 3 # give xvfb some time to start
    script:
    - mvn org.jacoco:jacoco-maven-plugin:prepare-agent-integration verify org.jacoco:jacoco-maven-plugin:report-integration -DskipUnitTests=true -Djbehave.report.level=STORY -Pintegration-test -B -V
    - curl --silent -o jbehave-support-core/target/codacy-reporter-latest.jar -L https://github.com/codacy/codacy-coverage-reporter/releases/download/4.0.3/codacy-coverage-reporter-4.0.3-assembly.jar
    - java -jar jbehave-support-core/target/codacy-reporter-latest.jar report -l Java -r jbehave-support-core/target/site/jacoco-it/jacoco.xml --partial
    - java -jar jbehave-support-core/target/codacy-reporter-latest.jar final
    after_success:
    - echo "gh token ${GITHUB_COMMENT_TOKEN}"
    - ./report_upload.sh ${GITHUB_COMMENT_TOKEN}
